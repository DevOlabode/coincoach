<% layout('./layout/boilerplate') %>

<style>
    .chat-container {
        height: calc(100vh - 100px);
        display: flex;
    }
    .sidebar {
        width: 280px;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }
    .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    .sessions-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }
    .session-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .session-item:hover {
        background: #e9ecef;
    }
    .session-item.active {
        background: #007bff;
        color: white;
    }
    .session-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .session-actions {
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .session-item:hover .session-actions {
        opacity: 1;
    }
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        background: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }
    .chat-header-title-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .chat-header-actions {
        display: flex;
        gap: 0.5rem;
    }
    .chat-header-actions button {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f8f9fa;
    }
    .message {
        margin-bottom: 1.5rem;
        display: flex;
        gap: 0.75rem;
    }
    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
    }
    .message.user .message-avatar {
        background: #007bff;
        color: white;
    }
    .message.assistant .message-avatar {
        background: #28a745;
        color: white;
    }
    .message-content {
        flex: 1;
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        position: relative;
    }
    .message-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
        display: flex;
        gap: 0.25rem;
    }
    .message-content:hover .message-actions {
        opacity: 1;
    }
    .message.edited .message-content::after {
        content: "(edited)";
        font-size: 0.75rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }
    .input-container {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
    }
    .input-wrapper {
        display: flex;
        gap: 0.5rem;
        max-width: 900px;
        margin: 0 auto;
    }
    .input-wrapper textarea {
        flex: 1;
        resize: none;
        border-radius: 1.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
        min-height: 44px;
        max-height: 200px;
    }
    .input-wrapper button {
        border-radius: 50%;
        width: 44px;
        height: 44px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }
    .loading {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
    }
    .loading-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6c757d;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>

<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button id="new-session-btn" class="btn btn-primary w-100">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>
        <div class="sessions-list" id="sessions-list">
            <!-- Sessions loaded here -->
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-header-title-wrapper">
                <h5 id="chat-title" contenteditable="false" style="margin: 0;">Select or create a chat</h5>
            </div>
            <div class="chat-header-actions" id="chat-header-actions" style="display: none;">
                <button class="btn btn-sm btn-outline-primary" onclick="editSessionTitle()" title="Edit Session Title">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrentSession()" title="Delete Session">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <div class="empty-state" id="empty-state">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h4>Welcome to Your Financial Coach</h4>
                <p>Start a new conversation to get personalized financial advice</p>
            </div>
        </div>

        <div class="input-container">
            <form id="chat-form" onsubmit="return false;">
                <div class="input-wrapper">
                    <input
                    class="form-control"
                        id="message-input"
                        placeholder="Ask about your spending, budgeting, or get financial advice..."
                        rows="1"
                        required
                    ></input>
                    <button type="submit" class="btn btn-primary">Enter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script>
let currentSessionId = null;
let sessions = [];
let messages = [];
let editingMessageId = null;

// Load sessions on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSessions();
    
    // Auto-resize textarea
    const textarea = document.getElementById('message-input');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
});

// New session button
document.getElementById('new-session-btn').addEventListener('click', createNewSession);

// Chat form submit
document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) return;
    
    if (editingMessageId) {
        await updateMessage(editingMessageId, content);
        editingMessageId = null;
    } else {
        if (!currentSessionId) {
            await createNewSession();
        }
        await sendMessage(content);
    }
    
    input.value = '';
    input.style.height = 'auto';
});

// Editable title
document.getElementById('chat-title').addEventListener('blur', async function() {
    if (currentSessionId && this.textContent.trim()) {
        await updateSessionTitle(currentSessionId, this.textContent.trim());
    }
});

document.getElementById('chat-title').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        this.blur();
    }
});

async function loadSessions() {
    try {
        const response = await fetch('/chat/sessions');
        sessions = await response.json();
        renderSessions();
    } catch (error) {
        console.error('Failed to load sessions:', error);
    }
}

function renderSessions() {
    const list = document.getElementById('sessions-list');
    list.innerHTML = sessions.map(session => `
        <div class="session-item ${session._id === currentSessionId ? 'active' : ''}" 
             data-id="${session._id}"
             onclick="loadSession('${session._id}')">
            <span class="session-title">${escapeHtml(session.title)}</span>
        </div>
    `).join('');
}

async function createNewSession() {
    try {
        const response = await fetch('/chat/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const session = await response.json();
        sessions.unshift(session);
        await loadSession(session._id);
        renderSessions();
        // Buttons will be shown in loadSession
    } catch (error) {
        console.error('Failed to create session:', error);
    }
}

async function loadSession(sessionId) {
    try {
        currentSessionId = sessionId;
        
        const response = await fetch(`/chat/sessions/${sessionId}/messages`);
        messages = await response.json();
        
        const session = sessions.find(s => s._id === sessionId);
        const titleEl = document.getElementById('chat-title');
        titleEl.textContent = session.title;
        titleEl.contentEditable = 'true';
        
        // Show header actions buttons
        document.getElementById('chat-header-actions').style.display = 'flex';
        
        renderMessages();
        renderSessions();
        
        document.getElementById('empty-state').style.display = 'none';
    } catch (error) {
        console.error('Failed to load session:', error);
    }
}

function renderMessages() {
    const container = document.getElementById('messages-container');
    container.innerHTML = messages.map(msg => `
        <div class="message ${msg.role} ${msg.edited ? 'edited' : ''}" data-id="${msg._id}">
            <div class="message-avatar">
                ${msg.role === 'user' ? 'You' : 'AI'}
            </div>
            <div class="message-content">
                ${escapeHtml(msg.content).replace(/\n/g, '<br>')}
                ${msg.role === 'user' ? `
                    <div class="message-actions">
                        <button class="btn btn-sm btn-link" onclick="editMessage('${msg._id}', \`${msg.content.replace(/`/g, '\\`')}\`)" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-link" onclick="deleteMessage('${msg._id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
    
    container.scrollTop = container.scrollHeight;
}

async function sendMessage(content) {
    try {
        // Save user message
        const userMsgResponse = await fetch(`/chat/sessions/${currentSessionId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'user', content })
        });
        const userMsg = await userMsgResponse.json();
        messages.push(userMsg);
        renderMessages();
        
        // Show loading
        const container = document.getElementById('messages-container');
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
        container.appendChild(loadingDiv);
        container.scrollTop = container.scrollHeight;
        
        // Get AI response
        const conversationMessages = messages.map(m => ({
            role: m.role,
            content: m.content
        }));
        
        const aiResponse = await fetch('/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                messages: conversationMessages,
                sessionId: currentSessionId 
            })
        });
        const aiData = await aiResponse.json();
        
        loadingDiv.remove();
        
        // Save AI message
        const aiMsgResponse = await fetch(`/chat/sessions/${currentSessionId}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: 'assistant', content: aiData.message })
        });
        const aiMsg = await aiMsgResponse.json();
        messages.push(aiMsg);
        renderMessages();
        
        // Update session title if it's the first message
        const session = sessions.find(s => s._id === currentSessionId);
        if (session.title === 'New Chat') {
            const newTitle = content.substring(0, 50) + (content.length > 50 ? '...' : '');
            await updateSessionTitle(currentSessionId, newTitle);
        }
        
    } catch (error) {
        console.error('Failed to send message:', error);
        document.querySelector('.loading')?.remove();
    }
}

async function updateSessionTitle(sessionId, title) {
    try {
        await fetch(`/chat/sessions/${sessionId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title })
        });
        const session = sessions.find(s => s._id === sessionId);
        if (session) {
            session.title = title;
            // Update the displayed title if it's the current session
            if (currentSessionId === sessionId) {
                const titleEl = document.getElementById('chat-title');
                titleEl.textContent = title;
            }
        }
        renderSessions();
    } catch (error) {
        console.error('Failed to update title:', error);
    }
}

async function editSessionTitle() {
    if (!currentSessionId) return;
    
    const session = sessions.find(s => s._id === currentSessionId);
    if (!session) return;
    
    const newTitle = prompt('Enter new session title:', session.title);
    if (newTitle === null || newTitle.trim() === '') return;
    
    await updateSessionTitle(currentSessionId, newTitle.trim());
    
    // Update the displayed title
    const titleEl = document.getElementById('chat-title');
    titleEl.textContent = newTitle.trim();
}

async function deleteCurrentSession() {
    if (!currentSessionId) return;
    
    if (!confirm('Delete this chat session?')) return;
    
    await deleteSession(currentSessionId);
}

async function deleteSession(sessionId) {
    try {
        await fetch(`/chat/sessions/${sessionId}`, { method: 'DELETE' });
        sessions = sessions.filter(s => s._id !== sessionId);
        
        if (currentSessionId === sessionId) {
            currentSessionId = null;
            messages = [];
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('chat-title').textContent = 'Select or create a chat';
            document.getElementById('chat-title').contentEditable = 'false';
            
            // Hide header actions buttons
            document.getElementById('chat-header-actions').style.display = 'none';
        }
        
        renderSessions();
    } catch (error) {
        console.error('Failed to delete session:', error);
    }
}

function editMessage(messageId, content) {
    editingMessageId = messageId;
    const input = document.getElementById('message-input');
    input.value = content;
    input.focus();
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 200) + 'px';
}

async function updateMessage(messageId, content) {
    try {
        await fetch(`/chat/sessions/messages/${messageId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        
        const msg = messages.find(m => m._id === messageId);
        if (msg) {
            msg.content = content;
            msg.edited = true;
        }
        renderMessages();
    } catch (error) {
        console.error('Failed to update message:', error);
    }
}

async function deleteMessage(messageId) {
    if (!confirm('Delete this message?')) return;
    
    try {
        await fetch(`/chat/sessions/messages/${messageId}`, { method: 'DELETE' });
        messages = messages.filter(m => m._id !== messageId);
        renderMessages();
    } catch (error) {
        console.error('Failed to delete message:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>